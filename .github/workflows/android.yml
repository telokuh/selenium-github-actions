name: Docker KVM Android 13 Emulator via Tailscale

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  # Konfigurasi Umum
  VNC_USER: runner
  NOVNC_PORT: 6080
  # Konfigurasi Tailscale
  TS_HOSTNAME: gh-kvm-android
  # Konfigurasi Docker (Menggunakan image yang diminta)
  DOCKER_IMAGE: budtmo/docker-android:emulator_13.0
  
jobs:
  run-docker-emulator:
    # KVM hanya tersedia dan paling stabil di runner Linux
    runs-on: ubuntu-latest 
    timeout-minutes: 370
    
    steps:
      - uses: actions/checkout@v4

      # 1. AKTIVASI KVM DI HOST RUNNER
      - name: âš™ï¸ Enable KVM Hardware Acceleration
        run: |
          echo ">>> Enabling KVM permissions on host..."
          # Mengatur perizinan 0666 untuk /dev/kvm
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          # Tambahkan user 'runner' ke grup 'kvm'
          sudo usermod -aG kvm $USER
          
      # 2. SETUP TAILSCALE PADA HOST RUNNER
      - name: ðŸ”— Setup Tailscale on Host Runner
        run: |
          echo ">>> Installing Tailscale on Host..."
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          
      - name: ðŸ”— Tailscale up (Persistent)
        run: |
          # Menggunakan vars.AUTHKEY seperti yang diminta
          AUTH_KEY="${{ vars.AUTHKEY }}"
          if [ -z "$AUTH_KEY" ]; then
            echo "Error: vars.AUTHKEY is empty. Please set the Tailscale Auth Key in Repository Variables."
            exit 1
          fi
          
          echo ">>> Connecting Tailscale..."
          # --network=host tidak diperlukan di sini karena ini adalah host runner.
          sudo tailscale up \
            --authkey "$AUTH_KEY" \
            --hostname ${{ env.TS_HOSTNAME }} \
            --accept-routes \
            --accept-dns=false \
            --timeout=0
            
          sleep 5

      # 3. MENJALANKAN DOCKER EMULATOR
      - name: ðŸ³ Run Docker Android Emulator
        id: run-docker
        run: |
          echo ">>> Pulling and Running Docker Emulator..."
          
          # Cek keberadaan KVM device sebelum menjalankan
          if [ ! -e /dev/kvm ]; then
            echo "WARNING: /dev/kvm not found despite setup. Emulator might fail or run slow."
          fi
          
          # Perintah 'docker run' dengan KVM dan network host:
          # --privileged & --device=/dev/kvm: Memungkinkan akselerasi hardware
          # --network=host: Penting agar Tailscale di host bisa mengakses port container (6080)
          docker run \
            --privileged \
            --detach \
            --network=host \
            --name=android-emu \
            --device=/dev/kvm \
            ${{ env.DOCKER_IMAGE }}
            
          echo "Menunggu container dan emulator boot (120 detik)..."
          sleep 120
          
          # Tampilkan log startup container untuk debugging
          echo "=== DOCKER CONTAINER LOGS ==="
          docker logs android-emu
          echo "============================="
          
          # Periksa apakah container masih berjalan
          if ! docker ps | grep -q "android-emu"; then
            echo "Error: Docker container stopped unexpectedly after startup. Check the logs above for the cause (likely KVM failure or Emulator crash)."
            exit 1
          fi

      # 4. TAMPILKAN URL DAN JAGA TETAP HIDUP
      - name: Show Connection URL and Keep Alive
        run: |
          # Pastikan Tailscale online
          TAILSCALE_IP=$(tailscale ip -4 | head -n1)
          VNC_URL="http://${TAILSCALE_IP}:${{ env.NOVNC_PORT }}/vnc.html"

          echo "==========================================="
          echo "=== KONEKSI DOCKER KVM VIA TAILSCALE ==="
          echo "==========================================="
          echo "URL NO VNC (Akses dari Browser Anda):"
          echo "${VNC_URL}"
          echo "==========================================="
          
          echo ">>> Keeping runner and container alive (Timeout 370 mins)..."
          # Loop keep alive, memantau container
          while true; do
            if ! docker ps | grep -q "android-emu"; then
              echo "Docker container stopped. Ending job."
              exit 1
            fi
            # Kirim sinyal adb/ping setiap 5 menit (300 detik) untuk menjaga koneksi tetap hidup
            docker exec android-emu /opt/android-sdk/platform-tools/adb shell echo "Container is alive." || true
            sleep 300 
          done
