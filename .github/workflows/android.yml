name: Android Emulator + noVNC via Tailscale

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  # Konfigurasi VNC/Pengguna
  VNC_USER: runner
  VNC_PASS: runner
  VNC_PORT: 5901
  NOVNC_PORT: 6080
  # Konfigurasi Android
  ANDROID_API: 30
  AVD_NAME: MyAndroidDevice
  ANDROID_SDK_ROOT: ${{ github.workspace }}/android_sdk
  # Konfigurasi Tailscale
  TS_HOSTNAME: gh-android-novnc
  
jobs:
  setup-gui-runner:
    runs-on: ubuntu-latest
    timeout-minutes: 370 # Beri waktu yang cukup panjang
    
    steps:
      - uses: actions/checkout@v4

      # --- [ BAGIAN SETUP PENGGUNA & VNC ] ---

      - name: Ensure runner user exists and configure VNC password
        run: |
          # Perintah ini menyesuaikan sandi pengguna 'runner' yang sudah ada di environment GitHub Actions
          echo "${{ env.VNC_USER }}:${{ env.VNC_PASS }}" | sudo chpasswd
          echo "${{ env.VNC_USER }} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${{ env.VNC_USER }}

      - name: Install XFCE, VNC Server, and noVNC/Websockify
        run: |
          echo ">>> Updating & Installing Base Components..."
          sudo apt-get update -qq
          # Menghilangkan xfce4-goodies dan chromium-browser untuk kecepatan. Menambahkan git dan python3-websockify.
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            xfce4 xorg dbus-x11 \
            tigervnc-standalone-server tigervnc-common \
            git python3-websockify jq
          
          echo ">>> Configuring VNC..."
          # Pastikan direktori VNC dibuat dan di-own oleh user runner (default)
          mkdir -p /home/${{ env.VNC_USER }}/.vnc
          echo ${{ env.VNC_PASS }} | vncpasswd -f > /home/${{ env.VNC_USER }}/.vnc/passwd
          chmod 600 /home/${{ env.VNC_USER }}/.vnc/passwd
          chown -R ${{ env.VNC_USER }}:${{ env.VNC_USER }} /home/${{ env.VNC_USER }}/.vnc
          
          # Start XFCE when VNC launches
          echo "startxfce4" > /home/${{ env.VNC_USER }}/.xsession
          chown ${{ env.VNC_USER }}:${{ env.VNC_USER }} /home/${{ env.VNC_USER }}/.xsession
          
          echo ">>> Installing noVNC..."
          git clone https://github.com/novnc/noVNC.git /opt/noVNC
          ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
          
      # --- [ BAGIAN SETUP CACHE & TAILSCALE ] ---

      - name: ⚙️ Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          # Ubah kepemilikan direktori state agar dapat di-cache
          sudo chown -R ${{ env.VNC_USER }}:${{ env.VNC_USER }} /var/lib/tailscale
          
      - name: 📦 Cache Tailscale State
        id: cache-ts
        uses: actions/cache@v3
        with:
          path: /var/lib/tailscale
          # Gunakan hostname sebagai key
          key: ${{ runner.os }}-tailscale-${{ runner.arch }}-${{ env.TS_HOSTNAME }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-tailscale-${{ runner.arch }}-${{ env.TS_HOSTNAME }}-
            
      - name: 🔗 Tailscale up (Persistent)
        run: |
          AUTH_PARAM=""
          if [[ "${{ steps.cache-ts.outputs.cache-hit }}" != "true" ]]; then
              echo "Cache Tailscale tidak ditemukan, menggunakan Authkey untuk pendaftaran."
              AUTH_PARAM="--authkey ${{ vars.AUTHKEY }}"
          else
              echo "Cache Tailscale ditemukan, terhubung kembali."
          fi
          
          # Gunakan AUTH_PARAM yang optional, dan hostname yang wajib
          sudo tailscale up \
            ${AUTH_PARAM} \
            --hostname ${{ env.TS_HOSTNAME }} \
            --accept-routes \
            --accept-dns=false \
            --timeout=0
            
          sleep 5 # Beri waktu agar koneksi Tailscale stabil

      # --- [ BAGIAN SETUP ANDROID EMULATOR ] ---

      - name: 🤖 Setup Java (Required for SDK)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: 📦 Cache Android SDK Components
        id: cache-sdk
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.ANDROID_SDK_ROOT }}/platforms
            ${{ env.ANDROID_SDK_ROOT }}/system-images
            ${{ env.ANDROID_SDK_ROOT }}/platform-tools
            ${{ env.ANDROID_SDK_ROOT }}/cmdline-tools/latest
          key: ${{ runner.os }}-android-sdk-${{ env.ANDROID_API }}-${{ hashFiles('**/sdk-install-marker.txt') }}
          restore-keys: |
            ${{ runner.os }}-android-sdk-${{ env.ANDROID_API }}-
          
      - name: 🔧 Install Android SDK Components
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          # Gunakan ANDROID_SDK_ROOT yang ditentukan
          export ANDROID_HOME=${{ env.ANDROID_SDK_ROOT }}
          mkdir -p $ANDROID_HOME
          
          # Install command-line tools
          echo "y" | sdkmanager "cmdline-tools;latest"
          
          # Tambahkan path tools ke GITHUB_PATH agar dikenal
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH 
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH 
          
          # Install platform dan system-image
          echo "y" | sdkmanager \
            "platform-tools" \
            "platforms;android-${{ env.ANDROID_API }}" \
            "system-images;android-${{ env.ANDROID_API }};google_apis;x86_64"
          
          touch sdk-install-marker.txt

      - name: 🏗️ Create AVD (Always Run)
        run: |
          export ANDROID_HOME=${{ env.ANDROID_SDK_ROOT }}
          
          # Pastikan path tools ada lagi (sering hilang setelah step)
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH 
          echo "$ANDROID_HOME/emulator" >> $GITHUB_PATH 
          
          # Membuat/menimpa AVD untuk memastikan keberadaannya
          echo "no" | avdmanager create avd -n ${{ env.AVD_NAME }} -k "system-images;android-${{ env.ANDROID_API }};google_apis;x86_64" --device "pixel" --force
          
          # Verifikasi AVD telah dibuat
          avdmanager list avd

      - name: 📱 Start Android Emulator in Background
        run: |
          export ANDROID_HOME=${{ env.ANDROID_SDK_ROOT }}
          
          echo "Memulai Android Emulator..."
          # Jalankan di bawah user VNC
          sudo -u ${{ env.VNC_USER }} nohup emulator -avd ${{ env.AVD_NAME }} -gpu swiftshader_indirect -no-audio -accel off &
          
          echo "Menunggu 120 detik agar emulator boot..."
          sleep 120 
          
          # Cek status AVD
          adb devices
          
      # --- [ BAGIAN START LAYANAN & KEEP ALIVE ] ---

      - name: Start VNC, noVNC proxy, and Show URL
        run: |
          echo ">>> Starting VNC server..."
          # Jalankan VNC di user VNC_USER
          sudo -u ${{ env.VNC_USER }} vncserver :1 -geometry 1280x800 -depth 24
          
          echo ">>> Starting noVNC websockify..."
          # Jalankan websockify di background
          nohup websockify --web=/opt/noVNC ${{ env.NOVNC_PORT }} localhost:${{ env.VNC_PORT }} &

          # Dapatkan IP Tailscale
          TAILSCALE_IP=$(tailscale ip -4 | head -n1)
          
          VNC_URL="http://${TAILSCALE_IP}:${{ env.NOVNC_PORT }}/vnc.html"

          echo "==========================================="
          echo "=== KONEKSI VNC VIA NO VNC / TAILSCALE ==="
          echo "==========================================="
          echo "USERNAME: ${{ env.VNC_USER }}"
          echo "PASSWORD: ${{ env.VNC_PASS }}"
          echo "IP TAILSCALE: ${TAILSCALE_IP}"
          echo "-------------------------------------------"
          echo "URL NO VNC (Akses dari Browser Anda):"
          echo "${VNC_URL}"
          echo "==========================================="
          
          echo ">>> Keeping runner alive (Timeout 370 mins)..."
          # Keep alive loop (600 detik = 10 menit)
          while true; do
            # Cek adb secara periodik agar emulator tetap aktif
            adb devices
            sleep 600
          done
