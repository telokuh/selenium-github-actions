name: Docker KVM Android 13 Emulator via Tailscale

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  # Konfigurasi Umum
  VNC_USER: runner
  NOVNC_PORT: 6080
  # Konfigurasi Tailscale
  TS_HOSTNAME: gh-kvm-android
  # Konfigurasi Docker
  DOCKER_IMAGE: budtmo/docker-android:emulator_13.0
  
jobs:
  run-docker-emulator:
    runs-on: ubuntu-latest 
    timeout-minutes: 370
    
    steps:
      - uses: actions/checkout@v4
      
      # 1. CACHING DOCKER: Menyimpan image dan layer yang diunduh
      - name: 📦 Cache Docker Layers
        id: cache-docker
        uses: actions/cache@v3
        with:
          path: /var/lib/docker
          # Key menggunakan nama image untuk memastikan cache yang benar
          key: ${{ runner.os }}-docker-${{ hashFiles('run-docker-image-key') }} 
          restore-keys: |
            ${{ runner.os }}-docker-
            
      # Jika cache tidak ditemukan, unduh image untuk pertama kali
      - name: Pull Docker Image (if not cached)
        if: steps.cache-docker.outputs.cache-hit != 'true'
        run: |
          echo "Docker cache not hit. Pulling image..."
          docker pull ${{ env.DOCKER_IMAGE }}
          # Buat file dummy untuk menandai bahwa image dasar telah di-pull,
          # ini membantu caching di run berikutnya.
          touch run-docker-image-key

      # 2. AKTIVASI KVM DI HOST RUNNER
      - name: ⚙️ Enable KVM Hardware Acceleration
        run: |
          echo ">>> Enabling KVM permissions on host..."
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo usermod -aG kvm $USER
          
      # 3. SETUP TAILSCALE PADA HOST RUNNER
      - name: 🔗 Setup Tailscale on Host Runner
        run: |
          echo ">>> Installing Tailscale on Host..."
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          
      - name: 🔗 Tailscale up (Persistent)
        run: |
          AUTH_KEY="${{ vars.AUTHKEY }}"
          if [ -z "$AUTH_KEY" ]; then
            echo "Error: vars.AUTHKEY is empty. Please set the Tailscale Auth Key in Repository Variables."
            exit 1
          fi
          
          echo ">>> Connecting Tailscale..."
          sudo tailscale up \
            --authkey "$AUTH_KEY" \
            --hostname ${{ env.TS_HOSTNAME }} \
            --accept-routes \
            --accept-dns=false \
            --timeout=0
            
          sleep 5

      # 4. MENJALANKAN DOCKER EMULATOR
      - name: 🐳 Run Docker Android Emulator
        id: run-docker
        run: |
          echo ">>> Running Docker Emulator..."
          
          if [ ! -e /dev/kvm ]; then
            echo "WARNING: /dev/kvm not found despite setup. Emulator might fail or run slow."
          fi
          
          # Perintah 'docker run' dengan KVM dan network host
          docker run \
            --privileged \
            --detach \
            --network=host \
            --name=android-emu \
            --device=/dev/kvm \
            ${{ env.DOCKER_IMAGE }}
            
          echo "Menunggu container dan emulator boot (120 detik)..."
          sleep 120
          
          # Tampilkan log startup container untuk debugging
          echo "=== DOCKER CONTAINER LOGS ==="
          docker logs android-emu
          echo "============================="
          
          # Periksa apakah container masih berjalan
          if ! docker ps | grep -q "android-emu"; then
            echo "Error: Docker container stopped unexpectedly after startup. Check the logs above for the cause (likely KVM failure or Emulator crash)."
            exit 1
          fi

      # 5. TAMPILKAN URL DAN JAGA TETAP HIDUP
      - name: Show Connection URL and Keep Alive
        run: |
          TAILSCALE_IP=$(tailscale ip -4 | head -n1)
          VNC_URL="http://${TAILSCALE_IP}:${{ env.NOVNC_PORT }}/vnc.html"

          echo "==========================================="
          echo "=== KONEKSI DOCKER KVM VIA TAILSCALE ==="
          echo "==========================================="
          echo "URL NO VNC (Akses dari Browser Anda):"
          echo "${VNC_URL}"
          echo "==========================================="
          
          echo ">>> Keeping runner and container alive (Timeout 370 mins)..."
          # Loop keep alive:
          # Menggunakan 'adb shell' tanpa jalur SDK eksplisit (perbaikan adb path)
          while true; do
            if ! docker ps | grep -q "android-emu"; then
              echo "Docker container stopped. Ending job."
              exit 1
            fi
            
            # Panggil adb tanpa jalur SDK eksplisit (mengandalkan PATH internal container)
            docker exec android-emu adb shell echo "Container is alive." || true
            
            sleep 300 
          done
