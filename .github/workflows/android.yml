name: Docker Android Emulator + noVNC via Tailscale

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  # Konfigurasi VNC/Pengguna (Digunakan untuk Tailscale Host)
  VNC_USER: runner
  VNC_PASS: runner
  NOVNC_PORT: 6080
  # Konfigurasi Tailscale
  TS_HOSTNAME: gh-docker-android
  # Nama image Docker yang akan digunakan (Ganti sesuai image Anda)
  DOCKER_IMAGE: budtmo/docker-android-x86-8.1
  
jobs:
  run-docker-emulator:
    runs-on: ubuntu-latest
    timeout-minutes: 370
    
    steps:
      - uses: actions/checkout@v4

      # --- [ BAGIAN SETUP TAILSCALE PADA HOST RUNNER ] ---

      - name: ⚙️ Install Tailscale on Host Runner
        run: |
          echo ">>> Installing Tailscale on Host..."
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          
      - name: 🔗 Tailscale up (Persistent)
        run: |
          # Perangkat Tailscale harus didaftarkan di host runner
          AUTH_PARAM="--authkey ${{ vars.AUTHKEY }}"
          
          # Gunakan sudo karena tailscale biasanya memerlukan izin root
          sudo tailscale up \
            ${AUTH_PARAM} \
            --hostname ${{ env.TS_HOSTNAME }} \
            --accept-routes \
            --accept-dns=false \
            --timeout=0
            
          sleep 5

      # --- [ BAGIAN MENJALANKAN DOCKER EMULATOR ] ---

      - name: 🐳 Run Docker Android Emulator
        run: |
          echo ">>> Pulling and Running Docker Emulator..."
          # Gunakan 'docker run' dengan argumen yang dibutuhkan emulator
          # --privileged diperlukan untuk virtualisasi (KVM/HAXM) di dalam container
          # --network=host memungkinkan container menggunakan port host secara langsung (penting untuk Tailscale)
          docker run \
            --privileged \
            --detach \
            --network=host \
            --name=android-emu \
            ${{ env.DOCKER_IMAGE }} &

          echo "Menunggu container dan emulator boot (120 detik)..."
          sleep 40
          
          # Verifikasi container berjalan
          docker ps -a
          
      # --- [ BAGIAN START LAYANAN & KEEP ALIVE ] ---

      - name: Show Connection URL and Keep Alive
        run: |
          # Pastikan Tailscale online
          timeout=60
          for i in $(seq 1 $timeout); do
              if /usr/bin/tailscale status --json | jq -e '.Self.Online' > /dev/null; then
                  break
              fi
              echo "Waiting for Tailscale to connect... ($i/$timeout s)"
              sleep 1
          done
          
          TAILSCALE_IP=$(tailscale ip -4 | head -n1)
          VNC_URL="http://${TAILSCALE_IP}:${{ env.NOVNC_PORT }}/vnc.html"

          echo "==========================================="
          echo "=== KONEKSI DOCKER EMULATOR VIA TAILSCALE ==="
          echo "==========================================="
          echo "URL NO VNC (Akses dari Browser Anda):"
          echo "${VNC_URL}"
          echo "==========================================="
          
          echo ">>> Keeping runner and container alive..."
          # Loop keep alive. Cek status container secara periodik.
          while true; do
            # Cek status container, jika berhenti, kita hentikan job
            if ! docker ps | grep -q "android-emu"; then
              echo "Docker container stopped unexpectedly."
              exit 1
            fi
            sleep 300 # Tunggu 5 menit
          done
